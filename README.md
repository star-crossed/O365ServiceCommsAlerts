# Office 365 Service Communications Alerts
This is a Microsoft Flow that posts cards of Office 365 Service Communications in a Microsoft Teams channel.

## How to Use This

You can find a zipped release version of these files in the Releases tab above. The zip file should import as-is into your Flow tenant with no errors. However, there are settings which will need to be changed to reflect your environment. These are:

- Get Messages: The URI field needs to have the tenant domain replaced.
- Get Messages: The Tenant field needs to have the tenant domain replaced.
- Get Messages: The Client ID field needs to have the client ID replaced.
- Get Messages: The Secret field needs to have the client secret replaced.
- Post a card in Alerts channel of IT Department team: The URI field needs to have the Incoming Webhook URL replaced.
- Post a card in Alerts channel of IT Department team: The Flow may not save because raw @ symbols appear in the Body field. To save, you may need to escape them with another @ symbol (e.g. @@type) before saving.

You will need to have an Incoming Webhook connector added to the channel in the team that you want to receive the alerts. You will also need to register an app in Azure AD to provide access to the Office 365 Service Communications API. Details on how to setup both of these items can be found in later sections of this page.

**Please submit an issue if you encounter any customizations or errors not described above during the import process.**

## How to Recreate the Flow

If you wish to recreate this Flow in your tenant rather than import it, you may do so by following these instructions. Begin by creating a blank Flow and then add a Recurrence trigger. This trigger dictates how often the messages potentially may be posted. In this example, it will post once daily (assuming new messages exist.)

![Recurrence](https://imgur.com/JcIrINn.png)

Next, you will add an Http action. The action should be configured as seen below. The following details should be modified to reflect your environment:

- Get Messages: The URI field needs to have the tenant domain replaced.
- Get Messages: The Tenant field needs to have the tenant domain replaced.
- Get Messages: The Client ID field needs to have the client ID replaced.
- Get Messages: The Secret field needs to have the client secret replaced.

The expression shown is to calculate today's date minus 1 day. This is used to filter and return only messages that were modified up to a day prior to the time when this Flow runs. If you opt for a different recurrence pattern, you will likely need to change this filter and expression to reflect what you need. A link to the Workflow Definition Language can be found at the end of this page to assist with editing the expression.

The authentication information can be obtained when registering an app in Azure AD. Information on what's required by the Office 365 Serivce Communications API can be found in the References section at the end of this page. Instructions on how to appropriate register an app for this Flow can be found in a later section of this page.

![Get Messages](https://imgur.com/eFxVjBO.png)

Now add a Parse Json action. The Content field should be set to use the Body property in the response from the Get Messages action. The schema can be generated by using a sample from the Office 365 Service Communications API documentation. I have included the resulting schema here to allow you to cut-and-paste it if you choose. The API documentation can be found in the References section at the end of this page.

`{
    "type": "object",
    "properties": {
        "@@odata.context": {
            "type": "string"
        },
        "value": {
            "type": "array",
            "items": {
                "type": "object",
                "properties": {
                    "@@odata.type": {
                        "type": "string"
                    },
                    "AffectedWorkloadDisplayNames": {
                        "type": "array",
                        "items": {
                            "type": "string"
                        }
                    },
                    "AffectedWorkloadNames": {
                        "type": "array",
                        "items": {
                            "type": "string"
                        }
                    },
                    "Status": {
                        "type": "string"
                    },
                    "Workload": {},
                    "WorkloadDisplayName": {},
                    "ActionType": {
                        "type": "string"
                    },
                    "AffectedTenantCount": {
                        "type": "number"
                    },
                    "AffectedUserCount": {},
                    "Classification": {
                        "type": "string"
                    },
                    "EndTime": {
                        "type": "string"
                    },
                    "Feature": {},
                    "FeatureDisplayName": {},
                    "Id": {
                        "type": "string"
                    },
                    "ImpactDescription": {},
                    "LastUpdatedTime": {
                        "type": "string"
                    },
                    "MessageType": {
                        "type": "string"
                    },
                    "Messages": {
                        "type": "array",
                        "items": {
                            "type": "object",
                            "properties": {
                                "MessageText": {
                                    "type": "string"
                                },
                                "PublishedTime": {
                                    "type": "string"
                                }
                            },
                            "required": [
                                "MessageText",
                                "PublishedTime"
                            ]
                        }
                    },
                    "PostIncidentDocumentUrl": {},
                    "Severity": {
                        "type": "string"
                    },
                    "StartTime": {
                        "type": "string"
                    },
                    "Title": {
                        "type": "string"
                    },
                    "ActionRequiredByDate": {},
                    "AnnouncementId": {
                        "type": "number"
                    },
                    "Category": {
                        "type": "string"
                    },
                    "ExternalLink": {
                        "type": "string"
                    },
                    "IsDismissed": {
                        "type": "boolean"
                    },
                    "IsRead": {
                        "type": "boolean"
                    },
                    "IsMajorChange": {
                        "type": "boolean"
                    },
                    "PreviewDuration": {},
                    "AppliesTo": {},
                    "MilestoneDate": {
                        "type": "string"
                    },
                    "Milestone": {
                        "type": "string"
                    },
                    "BlogLink": {
                        "type": "string"
                    },
                    "HelpLink": {
                        "type": "string"
                    },
                    "FlightName": {},
                    "FeatureName": {}
                },
                "required": [
                    "@@odata.type",
                    "AffectedWorkloadDisplayNames",
                    "AffectedWorkloadNames",
                    "Status",
                    "Workload",
                    "WorkloadDisplayName",
                    "ActionType",
                    "AffectedTenantCount",
                    "AffectedUserCount",
                    "Classification",
                    "EndTime",
                    "Feature",
                    "FeatureDisplayName",
                    "Id",
                    "ImpactDescription",
                    "LastUpdatedTime",
                    "MessageType",
                    "Messages",
                    "PostIncidentDocumentUrl",
                    "Severity",
                    "StartTime",
                    "Title",
                    "ActionRequiredByDate",
                    "AnnouncementId",
                    "Category",
                    "ExternalLink",
                    "IsDismissed",
                    "IsRead",
                    "IsMajorChange",
                    "PreviewDuration",
                    "AppliesTo",
                    "MilestoneDate",
                    "Milestone",
                    "BlogLink",
                    "HelpLink",
                    "FlightName",
                    "FeatureName"
                ]
            }
        }
    }
}`

![Parse Messages](https://imgur.com/OtUmRSZ.png)

Insert a condition next. This condition will be used to test whether any messages were retrieved per the filter in Get Messages. It tests if the length of the array of messages is greater than 0, which indicates at least one message was returned. The expression used is:

`length(body('Parse_Messages')?['value'])`

![Are there any messages](https://imgur.com/PDMB4Y1.png)

The No branch of the condition will remain blank. If no messages are returned, we want the Flow to silently exit the Flow. Inside the Yes branch, we will need to add an Apply to Each action. Even if only one message is returned, the data will come in the form of an array. This means we need to use the Apply to Each to ensure that we are processing all returned messages regardless of quantity. The Output field for this action should be configured to use the value property in the response from the Parse Messages action.

![Do this for each message](https://imgur.com/jfo3DGp.png)

Place an Http action inside the Apply to Each action. This action will be responsible for posting the card to our channel in Microsoft Teams. The channel and team are configured as part of the Incoming Webhook setup. Information on that setup can be found in a later section of this page. This action should be configured as seen below. The following fields will need to be customized to reflect your environment:

- Post a card in Alerts channel of IT Department team: The URI field needs to have the Incoming Webhook URL replaced.

The Body field contains the markup used to represent the card posted in Teams. This markup can be customized as you see fit. A link to the documentation on the markup can be found in the References section later in this page. The markup I have used is shown below so that you can cut-and-paste it if you like.

`{
  "@@type": "MessageCard",
  "@@context": "http://schema.org/extensions",
  "text": "@{last(item().Messages).MessageText}",
  "title": "@{items('Do_this_for_each_message')?['Title']}",
  "sections": [
    {
      "facts": [
        {
          "name": "Services Affected",
          "value": "@{join(item().AffectedWorkloadDisplayNames, ', ')}"
        }
      ]
    }
  ],
  "potentialAction": [
    {
      "@@context": "http://schema.org",
      "@@type": "ViewAction",
      "name": "View related article",
      "target": [
        "@{items('Do_this_for_each_message')?['ExternalLink']}"
      ]
    }
  ]
}`

![Post a card in Alerts channel of IT Department team](https://imgur.com/5gfe0D2.png)

Your Flow is now ready to run! You can test it out, but you may find that no card is posted because no new messages fall within the filter criteria. In this case, you may wish to temporarily alter the filter to allow some historical messages to be added to the channel to "seed" it with some initial content. Just be sure to reset the filter to match your desired recurrence schedule when you are finished. A sample of a posted card can be seen below.

![Sample](https://imgur.com/8zNU9BH.png)

## How to Create the Incoming Webhook URL

Start by clicking the 3-dots icon next to the channel name and choosing Connectors. This should pop-up a list of connectors that you can add to your channel. Click the Add button next to the Incoming Webhook connector.

![Add Incoming Webhook Connector](https://imgur.com/tl0qFJ9.png)

Fill in the required information to create the webhook as shown below. Note that the name chosen will be the "user name" that the cards will be posted under in your channel.

![Create Incoming Webhook](https://imgur.com/Twb5jPj.png)

Upon creation of the webhook, the form will change to give you a URL for posting cards in your channel. You will copy-and-paste this URL into URI field of the Post a Card action of your Flow. When you have done so, you can safely close this dialog by clicking the Done button. 

![Incoming Webhook URL](https://imgur.com/bOpfDok.png)

After closing the previous dialog, you are redirected to the list of installed and configured connectors for this channel. If you need to retrieve the URL again or make changes to the name or image, click the Configure button from this list to do so.

![Connectors](https://imgur.com/GY2P6uN.png)

You'll note that adding this connector has posted a notice to the channel that the connector has been added. This is purely informational and can be deleted if desired. Removing this post will not remove the connector itself from your channel.

![Webhook Installed](https://imgur.com/Lquk8Hg.png)

## How to Register the App in Azure AD

To retrieve the messages from the Office 365 Service Communications API, we will need to register an application in Azure AD with the proper permissions. Start by going to App Registrations in Azure AD. Click the New Registration button, fill in the form as shown below, and click the Register button.

![Register an Application](https://imgur.com/AR58jAK.png)

Next, you'll create a client secret. In App Registrations, click on the app you registered above. Choose Client & Secrets from the menu on the left. Click the New Client Secret button to bring up the dialog shown below. Select Never if you do not wish for your client secret to expire. Hit the Add button to save your secret. 

![Add a Client Secret](https://imgur.com/d9nQFcL.png)

Note that you'll only get to copy it one time immediately following this save. Subsequent visits to the page will display an obfuscated version of the secret instead.

![Client Secrets](https://imgur.com/IH1F39M.png)

Once you have created a client secret, you must also set the API permissions. While in App Registrations, select the app you have registered for this and choose API Permissions from the menu on the left. You'll then be presented with a selection of APIs to choose from. The one we are using for this Flow is th e Office 365 Management APIs found in the Microsoft APIs tab.

![Select an API](https://imgur.com/wN8i7yv.png)

Select Application Permissions and click the Expand All button. You will need to check the permissions shown below: ActivityFeed.Read and ServiceHealth.Read. Click the Add Permissions button to save these permissions.

![What type of permissions](https://imgur.com/chBaVu7.png)

Lastly, you'll need to grant consent for these permissions. This can be done by clicking the Grant Admin Consent button at the bottom of the API Permissions page. Upon doing so, you'll notice the Consent Required column has changed for the permissions selected. 

![Grant Admin Consent](https://imgur.com/HfPj8wG.png)

Be sure to copy-and-paste the Client ID and Client Secret into the Get Messages action in your Flow as described in the previous section of this page.

## References

[Get started with Office 365 Management APIs](https://docs.microsoft.com/en-us/office/office-365-management-api/get-started-with-office-365-management-apis)

[Schema reference for Workflow Definition Language in Azure Logic Apps](https://docs.microsoft.com/en-us/azure/logic-apps/logic-apps-workflow-definition-language)

[Introducing Office 365 Connectors for Microsoft Teams](https://docs.microsoft.com/en-us/microsoftteams/platform/concepts/connectors/connectors)

[Legacy actionable message card reference](https://docs.microsoft.com/en-us/outlook/actionable-messages/message-card-reference)

[Message Card Playground](https://messagecardplayground.azurewebsites.net/)

[Adaptive Card Designer](https://acdesignerstaging.azurewebsites.net/)
